{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container py-4">
  <h4 class="fw-bold mb-4 text-center text-primary">
    ‚úèÔ∏è Edit Invoice - {{ invoice.invoice_no }}
  </h4>

  <form method="POST" class="card p-4 shadow-lg bg-light rounded-4" id="invoiceForm">
    {% csrf_token %}
    
    <!-- üîπ Customer Info -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Customer Name</label>
        <input type="text" name="customer_name" class="form-control glow-field"
               value="{{ invoice.customer_name }}">
      </div>
      <div class="col-md-6">
        <label class="form-label">Customer Phone</label>
        <input type="text" name="customer_phone" class="form-control glow-field"
               value="{{ invoice.customer_phone }}">
      </div>
    </div>

    <!-- üîπ Product Details -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Product</label>
        <input type="text" name="product" class="form-control glow-field"
               value="{{ invoice.override_product_name }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Unit Price (‚Çπ)</label>
        <input type="number" step="0.01" name="price" id="price"
               class="form-control glow-field"
               value="{{ invoice.override_unit_price }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Quantity</label>
        <input type="number" name="quantity" id="quantity"
               class="form-control glow-field"
               value="{{ invoice.override_quantity }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Discount (%)</label>
        <input type="number" step="0.01" name="discount" id="discount"
               class="form-control glow-field"
               value="{{ invoice.discount }}">
      </div>
    </div>

    <!-- üîπ Financial Fields -->
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">GST (%)</label>
        <input type="number" step="0.01" name="gst" id="gst"
               class="form-control glow-field"
               value="{{ invoice.gst }}">
      </div>

      <div class="col-md-3">
        <label class="form-label">Total (‚Çπ)</label>
        <input type="number" step="0.01" name="total" id="total"
               class="form-control glow-field"
               value="{{ invoice.total|floatformat:2 }}" readonly>
      </div>

      <div class="col-md-3">
        <label class="form-label">Cash Received (‚Çπ)</label>
        <input type="number" step="0.01" name="cash_received" id="cash_received"
               class="form-control glow-field"
               value="{{ invoice.cash_received }}">
      </div>

    <!-- üîπ Status -->
    <div class="mb-3">
      <label class="form-label">Status</label>
      <select name="status" class="form-select glow-field">
        <option value="Unpaid" {% if invoice.status == "Unpaid" %}selected{% endif %}>Unpaid</option>
        <option value="Paid" {% if invoice.status == "Paid" %}selected{% endif %}>Paid</option>
        <option value="Partial" {% if invoice.status == "Partial" %}selected{% endif %}>Partial</option>
      </select>
    </div>

    <button type="submit" class="btn btn-primary w-100 mt-3 fw-semibold shadow">
      üíæ Save Changes
    </button>
  </form>
</div>

<!-- üåà STYLING -->
<style>
  .form-control, .form-select {
    transition: all 0.3s ease-in-out;
    border-radius: 10px;
    border: 1px solid #ced4da;
  }

  .form-control:hover, .form-select:hover {
    border-color: #495057;
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.45);
  }

  .form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 10px rgba(13, 110, 253, 0.6);
  }
</style>

<!-- ‚öôÔ∏è LIVE TOTAL CALCULATION SCRIPT -->
<script>
  function calculateTotal() {
    let price = parseFloat(document.getElementById('price').value) || 0;
    let quantity = parseFloat(document.getElementById('quantity').value) || 0;
    let discount = parseFloat(document.getElementById('discount').value) || 0;
    let gst = parseFloat(document.getElementById('gst').value) || 0;

    // Same formula as Django model
    let base = price * quantity;
    let afterDiscount = base - (base * discount / 100);
    let gstAmount = afterDiscount * (gst / 100);
    let total = afterDiscount + gstAmount;

    document.getElementById('total').value = total.toFixed(2);

    // Optional: auto update balance due
    let cash = parseFloat(document.getElementById('cash_received').value) || 0;
    document.getElementById('balance_due').value = (total - cash).toFixed(2);
  }

  document.querySelectorAll('#price, #quantity, #discount, #gst, #cash_received').forEach(el => {
    el.addEventListener('input', calculateTotal);
  });

  // Run on page load
  calculateTotal();
</script>

{% endblock %}
